$(function(){
	// location.hash = 'main';
	document.addEventListener("deviceready", onDeviceReady, false); 
	// PhoneGap is loaded and it is now safe to make calls PhoneGap methods
	function onDeviceReady() {
		// 注册回退按钮事件监听器
		document.addEventListener("backbutton",Global.handleBack.onBackBtn,false);
	}
	/*==========================
	 * alert重载
	 * ========================*/
	(function(){
		document.addEventListener("deviceready", function(){
			window.alert = function(){
				navigator.notification.alert(arguments[0],null,'消息');
			}
		}, false); 
	})();
});
/*=====================================================
 * Global命名空间
 * 页面模块匿名函数都加入命名空间中，通信使用public变量
 * 例如around模块，Global.around = new （function(){})();
 * 记得开放通信接口，通信就用
 * Global.around.sendData（a，b，c）之类的
 * ====================================================*/
Global = {};

/*===================================
公共全局数据
==================================*/
Global.common = {};
Global.common.access_token = null;
//zj
// Global.common.access_token = "d33f6176154ca6c079be24623fe5f440";

// Global.common.longitude = "113.404773";
// Global.common.latitude = "23.059658";

Global.common.longitude = null;
Global.common.latitude = null;

//jh
// Global.common.access_token = "6b30de9f313ad68841929bdd93b08398";
// Global.common.access_token = null;

/*=====================================================
 * 本地存储
 * ===================================================*/
//================key-value本地存储====================
function kset( key , value )
{
	window.localStorage.setItem( key , value );
}

function kget( key )
{
	return window.localStorage.getItem( key );
}

function kremove( key )
{
	window.localStorage.removeItem( key );
}


//===================数据库本地存储=================
//构造数据库表
// function populateDB(tx) {
	// tx.executeSql('CREATE TABLE IF NOT EXISTS message (id unique, from_uid , date , content)');
// }

// function errorCB(err) {
	// console.log("Error processing SQL: "+err.code);
// }

// function successCB() {
	// console.log("success!");
// }

//====================初始化数据=====================
$(function(){
	//浏览器测试
	// onDeviceReady();
	Global.common.access_token = kget('access_token');
	//手机
	// document.addEventListener("deviceready", onDeviceReady, false);
})

// function onDeviceReady() {
	// Global.DB = window.openDatabase("DOUYADB", "1.0", "DYDB", 200000);
	// Global.DB.transaction(populateDB, errorCB, successCB);
	//读出kv本地存储数据
// }

/*=============================
 * 异步加载baidu API
 * ============================*/
var MapLoader = new(function(){
	this.isReady = false;
	_funcQueue = [];

	window.onload = loadScript;

	this.ready = function(func){
		if(this.isReady == true){
			func();
		}else{
			_funcQueue.push(func);
		}
	} 

	this.initialize = function() {
		this.isReady = true;
		while(_funcQueue.length >0 ){
			var func = _funcQueue.shift();
			func();
		}
	}
	 
	function loadScript() {
	  var script = document.createElement("script");
	  script.src = "http://api.map.baidu.com/api?v=1.3&callback=MapLoader.initialize";
	  document.body.appendChild(script);
	}
	
})

/*============================================
 * iScroll修改版，带上拉,下扯块
 * ===========================================*/
function MyScrollBuilder(id,option){
	var _option = {
		pullDownId:null,
		onPullDownScrollEnd:null,
		pullUpId:null,
		opPullUpScrollEnd:null
	};
	$.extend(_option,option);
	
	if(_option.pullDownId !== null){
		var pullDownEl = document.getElementById(_option.pullDownId);
		var pullDownOffset = $("#"+_option.pullDownId).outerHeight();
	}
	if(_option.pullUpId !== null){
		var pullUpEl = document.getElementById(_option.pullUpId);
		var pullUpOffset = $("#"+_option.pullUpId).outerHeight();
	}
	
	return new iScroll(id, {
		useTransition: true,
		topOffset: pullDownOffset,
		onRefresh: function () {
			if (pullDownEl !== undefined && pullDownEl.className.match('loading')) {
				pullDownEl.className = 'pullDown';
				pullDownEl.querySelector('.pullDownLabel').innerHTML = '刷新';
			}else if (pullUpEl !== undefined && pullUpEl.className.match('loading')) {
				pullUpEl.className = 'pullUp';
				pullUpEl.querySelector('.pullUpLabel').innerHTML = '获取更多';
			}
		},
		onScrollMove: function () {
			if (pullDownEl !== undefined && this.y > 5 && !pullDownEl.className.match('flip')) {
				pullDownEl.className = 'pullDown flip';
				pullDownEl.querySelector('.pullDownLabel').innerHTML = '可以放手啦';
				this.minScrollY = 0;
			} else if (pullDownEl !== undefined && this.y < 5 && pullDownEl.className.match('flip')) {
				pullDownEl.className = 'pullDown';
				pullDownEl.querySelector('.pullDownLabel').innerHTML = '刷新';
				this.minScrollY = -pullDownOffset;
			}else if(pullUpEl !== undefined && (
				(this.y < (this.maxScrollY-pullUpOffset) && this.maxScrollY < 0) || ((this.y < -1.5*pullUpOffset) &&  this.maxScrollY >0))&& !pullUpEl.className.match('flip')) {
				pullUpEl.className = 'pullUp flip';
				pullUpEl.querySelector('.pullUpLabel').innerHTML = '可以放手啦';
				this.maxScrollY = this.maxScrollY;
			} else if (pullUpEl !== undefined && (
				(this.y > (this.maxScrollY-pullUpOffset) && this.maxScrollY < 0) || ((this.y > -1.5*pullUpOffset) &&  this.maxScrollY >0)) && pullUpEl.className.match('flip')) {
				pullUpEl.className = 'pullUp';
				pullUpEl.querySelector('.pullUpLabel').innerHTML = '获取更多';
			}
		},
		onScrollEnd: function () {
			if (pullDownEl !== undefined && pullDownEl.className.match('flip')) {
				pullDownEl.className = 'pullDown loading';
				pullDownEl.querySelector('.pullDownLabel').innerHTML = '加载中...';
				if(_option.onPullDownScrollEnd != null){
					_option.onPullDownScrollEnd();
				}
			} else if (pullUpEl !== undefined && pullUpEl.className.match('flip')) {
				pullUpEl.className = 'pullUp loading';
				pullUpEl.querySelector('.pullUpLabel').innerHTML = '加载中...';
				if(_option.onPullUpScrollEnd != null){
					_option.onPullUpScrollEnd();
				}
			}
		}
	});
}

/*=========================
 * 定义后退按钮
 * ========================*/
Global.handleBack = new (function(){
	var fun = {};
	this.addBack = function(){
		var a = arguments[0];
		fun[a] = arguments[1];
	}
	this.onBackBtn = function(){
		var hash = location.hash.slice(1);
		if(fun[hash]){
			fun[hash]();
		}else{
			window.history.back(1);
		}
	}
})();

/*======================
 * main模块
 * ====================*/
;Global.main = new (function(){
	var search_box = $('.main .searchInput');
	var query;
	var btn = $('.main .searchBtn');
	var count = -1;

	$('.main').live('pagehide',function(){
		count = -1;
	});
	
	$('.main .icon a').live('vmousedown',function(){
		$(this).css('background-color','#DCECDC');
	});

	$(document).live('vmouseup',function(){
		$('.main .icon a').css('background-color','transparent');
	});

	btn.live('vmousedown',function(){
		$(this).parent('.searchBtn_div').attr('id','s_btn_tapDown');
	});

	$(document).live('vmouseup',function(){
		if($('#s_btn_tapDown').length)
			$('#s_btn_tapDown').attr('id','');
	});

	btn.live('tap',function(){
		query = search_box.val();
		if(!query){
			alert('请输入书名或isbn号');
			return;
		}
		if(!isNaN(query)){
			Global.Around.searchByIsbn(query);
		}else{
			Global.Around.searchByTitle(query);
		}
	});

	Global.handleBack.addBack('main',function(){
		if(!count){
			count = -1;
			navigator.app.exitApp();
		}else{
			count++;
			alert('再按一次返回键退出');
		}
	});
});

/*==================================
 * Around模块
 *==================================*/
;Global.Around = new (function(){
	var pullDownEl,pullUpEl;
	var myScroll;
	var scrollListJDom = null;
	var ItemIdStart=0,ItemIdEnd=0;//start 相对于更大的id
	var myLatitude,myLongitude;
	var range = 500;
	var apiSrc = 'http://4.huanyou.sinaapp.com/swap_message/around';
	var _isbn = null;
	var _title = null;
	var _needRefresh = true;
	var _refreshDisable = false;
	var _loadMoreDisable = false;

	//按isbn搜索并跳页
	this.searchByIsbn = function(isbn){
		$("#around .banner").html("搜索");
		$("#around .positionArea .left-block").hide();
		window.location.hash = "around";
		apiSrc = 'http://4.huanyou.sinaapp.com/swap_message/search_by_Isbn';
		_isbn = isbn;
		_needRefresh = true;
	}

	//按书名搜索并跳页
	this.searchByTitle = function(title){
		$("#around .banner").html("搜索");
		$("#around .positionArea .left-block").hide();
		window.location.hash = "around";
		apiSrc = 'http://4.huanyou.sinaapp.com/swap_message/search_by_title';
		_title = title;
		_needRefresh = true;
	}

	//查看周围
	this.searchAround = function(){
		$("#around .banner").html("周边");
		$("#around .positionArea .left-block").show();
		window.location.hash = "around";
		apiSrc = 'http://4.huanyou.sinaapp.com/swap_message/around';
		_needRefresh = true;
	}

	//摇一摇
	this.rock = function(){
		$("#around .banner").html("抖一抖");
		$("#around .positionArea .left-block").hide();
		window.location.hash = "around";
		apiSrc = 'http://4.huanyou.sinaapp.com/swap_message/shake?r=' + Math.random();
		_needRefresh = true;
	}

	function init(){
		ItemIdStart = 0,ItemIdEnd = 0;
		scrollListJDom.empty();
		showLoading();
		refreshData();
		_needRefresh = false;
	}

	//读入id比ItemIdStart大新数据
	function refreshData(){
		if(_refreshDisable){
			return;
		}
		_refreshDisable = true;
		$.get(apiSrc,{range:range,latitude:myLatitude,longitude:myLongitude,startIndex:ItemIdStart,isbn:_isbn,title:_title},function(data){
			try{
				data = JSON.parse(data);
			}catch(err){};
			if(data.code !== undefined && data.code == '1'){
				books = data.around;
				for(var i = books.length-1;i >=0 ; i--){
					books[i].starScore = Math.floor(books[i].score);
					if(books[i].mile >= 10000){
						books[i].mile = Math.floor(books[i].mile/1000) + "千";
					}  
				}
				ItemIdStart = books[0].id;
				if(scrollListJDom.children().length == 0){
					ItemIdEnd = books.slice(-1)[0].id;
				}
				$.tmpl("ArondMessageTmpl",books).prependTo(scrollListJDom);
			}else{
				if(scrollListJDom.children().length == 0){
					alert('没有找到符合条件的信息哦');
				}else{
					alert('别拉了，没有了啦');
				}
			}
			if(myScroll == null){
				loadScroll();
			}
			myScroll.refresh();
			_refreshDisable = false;
		})
	};
	
	//读入id比ItemIdEnd小的数据
	function loadMoreData(){
		if(_loadMoreDisable){
			return;
		}
		_loadMoreDisable = true;
		$.get(apiSrc,{range:range,latitude:myLatitude,longitude:myLongitude,endIndex:ItemIdEnd,isbn:_isbn,title:_title},function(data){
			data = JSON.parse(data);
			if(data.code !== undefined && data.code == '1'){
				books = data.around;
				for(var i = books.length-1;i >=0 ; i--){
					books[i].starScore = Math.floor(books[i].score);
				}
				$.tmpl("ArondMessageTmpl",books).appendTo(scrollListJDom);
				ItemIdEnd = books.pop().id;
			}else{
				alert('别拉了，没有了啦');
			}
			myScroll.refresh();
			_loadMoreDisable = false;
		})
	}

	function loadScroll(){
		$("#around-pullUp").show();
		myScroll = MyScrollBuilder('around-wrapper',{
			pullDownId : 'around-pullDown',
			onPullDownScrollEnd : refreshData,
			pullUpId : 'around-pullUp',
			onPullUpScrollEnd : loadMoreData
		});
	}

	//更新地点信息
	function updateAddress(){
		MapLoader.ready(function(){
			myGeo = new BMap.Geocoder();
			myPoint = new BMap.Point(myLongitude,myLatitude);
			myGeo.getLocation(myPoint, function(result){
				if (result.address){
					$("#around .positionArea .right-block .address").text(result.address);
				}else{
					$("#around .positionArea .right-block .address").text('未知地点');
				}
			});
		})
	}

	//定位
	function location(){
		$("#around-pullDown").children('.pullDownLabel').text('定位中...或者点击右下角选定位置');
		var onSuccess = function(position) {
			myLongitude = Global.common.longitude = position.coords.longitude;
			myLatitude = Global.common.latitude =  position.coords.latitude;
			updateAddress();
			refreshData();
		}

		var onError = function(error) {
			alert('定位服务未开启,请开启后重试,或者在地图上选择你所在的位置');
		}
		navigator.geolocation.getCurrentPosition(onSuccess, onError);
		
	}

	function showLoading(){
		$("#around-pullDown").addClass('loading');
		$("#around-pullDown").children('.pullDownLabel').text('刷新中...');
		if(myScroll != null){
			myScroll.destroy();
			myScroll = null;
			$("#around-pullUp").hide();
		}
	};


	$("#around .list li").live('tap',function(){
		var isbn = $(this).attr('data_isbn');
		var smid = $(this).attr('data_sid');
		Global.bookInfo.toViewInfo({
			isbn:isbn,
			smid:smid
		});
	});
	//选择距离后的动作
	$("#around .positionArea .select").change(function(){
		range = $(this).val();
		init();
	});
	
	$("#around").live('pageinit',function(){
		scrollListJDom = $("#around-wrapper .list").first();
		//编译模板
		$.template("ArondMessageTmpl",scrollListJDom);
		scrollListJDom.empty();
	});

	$("#around").live('pageshow',function(){
		myLongitude = Global.common.longitude;
		myLatitude = Global.common.latitude;
		if(Global.common.longitude == null || Global.common.latitude == null){
			location();
		}else{
			if(_needRefresh){
				init();
			}
		}
	});

	$("#around").live('pagehide',function(){
		$("#map_container").remove();
		$("#around").children().show();
	})

	$("#around .positionArea .right-block").live('tap',function(){
		Global.mymap.setBack(2);
		$("#around").children().css("display","none");
		$("#around").append('<div id="map_container" class="page map_container"></div>');
		Global.mymap.init();
	})

	this.setPos = function(pos,address){
		myLongitude = pos[0];
		myLatitude = pos[1];
		$("#around .positionArea .right-block .address").text(address);
		init();
	}

	this.getPos = function(){
		return [myLongitude,myLatitude];
	}
	
	this.refresh = function(){
		$("#around").children().css("display","");
	}
	
})();

/*=============================================
 * Friend模块
 * ==========================================*/
;Global.Friend = new (function(){
	var myScroll;
	var scrollListJDom;
	var pullDownEl;
	var _refreshDisable = false;
	
	//读入新数据
	function refreshData(){
		if(_refreshDisable){
			return;
		}
		_refreshDisable = true;
		$.get("http://4.huanyou.sinaapp.com/friend/friendList",{access_token:Global.common.access_token},function(result){
			try{
				result = JSON.parse(result);
			}catch(err){};
			if(result.code != undefined && result.code == '1'){
				scrollListJDom.empty();
				$.tmpl("FriendTpml",result.data).appendTo(scrollListJDom);
				if(typeof myScroll === 'object'){
					myScroll.refresh();
				}else{
					loadScroll();
				}
				if(scrollListJDom.children().length == 0){
					alert('你还没有好友哦!(向他人发送信息即可添加好友哦)');
				}
			}else{
				alert('网络好像不太给力,再试一次吧');
			}
			_refreshDisable = false;
		});
	}

	//加载iscroll
	function loadScroll(){
		myScroll = MyScrollBuilder('friend-wrapper',{
			pullDownId : 'friend-pullDown',
			onPullDownScrollEnd : refreshData
		});
	}

	function init(){
		scrollListJDom = $("#friend .list").first();
		//编译模板
		$.template("FriendTpml",scrollListJDom);
		scrollListJDom.empty();
	}

	//点击聊天按钮
	$("#friend .list .chat").live('tap',function(){
		uid = $(this).parent().attr('data-uid');
		nickName = $(this).siblings('.name').text();
		imgSrc = $(this).siblings('.avatar').attr('src');
		Global.Dialog.show(uid,nickName,imgSrc);
	});

	//点解删除按钮
	$("#friend .list .delete").live('tap',function(){
		uid = $(this).parent().attr('data-uid');
		deleteItem = $(this).parent();
		$.get('http://4.huanyou.sinaapp.com/friend/deleteFriend',{access_token:Global.common.access_token,uid:uid},function(result){
			try{
				result = JSON.parse(result);
			}catch(err){};
			if(result != null && result.code == '1'){
				deleteItem.remove();
			}else{
				navigator.notification.alert('删除失败,请重试',null,"提示");
			}
		});
	});

	$("#friend").live('pageinit',function(){
		init();
	});

	$("#friend").live('pageshow',function(){
		if(Global.common.access_token == null){
			alert("请先登陆");
			Global.Login.show();
		}else{
			//加载信息
			refreshData();
		}
	});

	Global.handleBack.addBack('friend',function(){
			location.hash = 'main';
	});
})();

/*=========================================
 * 对话模块
 * ========================================*/
Global.Dialog = new (function(){
	var scrollListJDom;
	var _talkingUid = 0;
	var _talkingNickName = null;
	var _talkingImgSrc = null;
	var _needLoadNewMsg = true;
	var myScroll = null;
	var _loadHistroyDisable = false;
	var myMedia = null;
	
	this.show = function(uid,nickName,imgSrc){
		_talkingUid = uid;
		_talkingNickName = nickName;
		_talkingImgSrc = imgSrc;
		window.location.hash = 'dialog';
	}

	function _getCurrentTime(){
		var a = new Date();
		var month = a.getMonth() + 1;
		if(month < 10){
			month = '0' + month;
		}
		return month +'-'+a.getDate()+' '+a.getHours()+':'+a.getMinutes()+':'+a.getSeconds();
	}

	function playAudioAndVibrate(){
		try{
			if(Global.Setting.voice == true){
				if(myMedia == null){
					myMedia = new Media("/android_asset/www/audio/dialog.mp3");

				}
				myMedia.play();
			}
			if(Global.Setting.vibration == true){
				navigator.notification.vibrate(500);
			}
		}catch(err){}
	}

	//定时获取新消息
	function loadNewMsg(){
		$.get('http://4.huanyou.sinaapp.com/private_message/chattingNewMessage',{access_token:Global.common.access_token,from_uid:_talkingUid,r:Math.random()},function(result){
			try{
				result = JSON.parse(result);
			}catch(err){};
			if(result.code !== undefined ){
				if(result.code == '1'){
					for(var i = result.data.length-1; i >= 0 ; i--) {
						result.data[i].imgsrc = _talkingImgSrc;
					}
					playAudioAndVibrate();
					$.tmpl("DialogYourMsgTmpl",result.data).appendTo(scrollListJDom);
					myScroll.refresh();
					if(myScroll.maxScrollY < 0 ){
						myScroll.scrollToElement('li:nth-last-child(1)', 200)
					}
					
				}
			}else{
				alert('服务器错误');
			}
			if(_needLoadNewMsg == true){
				setTimeout(loadNewMsg,10000);
			}
		})
	}
	//获取更多信息按钮点击事件
	$("#dialog .dialog-more").live('tap',function(){
		if(_loadHistroyDisable){
			return;
		}
		_loadMoreDisable = true;
		MsgList = $('#dialog .yourMsg,#dialog .myMsg');
		if(MsgList.length > 0){
			start_mid = MsgList.first().attr('data_mid');
		}else{
			start_mid = 0;
		}
		$.get('http://4.huanyou.sinaapp.com/private_message/historyMessage',{access_token:Global.common.access_token,from_uid:_talkingUid,pm_id:start_mid},function(result){
			try{
				result = JSON.parse(result);
			}catch(err){};
			if(result.code !== undefined && result.code == '1'){
				for(var i = result.data.length-1; i >= 0 ; i--) {
					result.data[i].imgsrc = _talkingImgSrc;
					if(result.data[i].user_id == _talkingUid){
						$.tmpl("DialogYourMsgTmpl",result.data[i]).prependTo(scrollListJDom);
					}else{
						$.tmpl("DialogMyMsgTmpl",result.data[i]).prependTo(scrollListJDom);
					}
				}
				myScroll.refresh();
			}else if(result.code !== undefined && result.code == '-1'){
				alert('没有消息啦');
			}
			_loadMoreDisable = false;
		})
	});
	
	$("#dialog .dialog-more").live('vmousedown',function(){
		$(this).addClass('dd_down');
	});
	$('#dialog').live('vmouseup',function(){
		if($('.dd_down').length)
			$('.dd_down').removeClass('dd_down');
	});

	//发送按钮点击事件
	$("#dialog-sendBtn").live('tap',function(){
		var sendTextJDOM = $("#dialog-sendText");
		if(sendTextJDOM.val() != ''){
			msg = sendTextJDOM.val();
			sendTextJDOM.val('')
			sendTextJDOM.empty();
			var data = {};
			data.send_time = _getCurrentTime();
			data.content = msg;
			$.tmpl("DialogMyMsgTmpl",data).appendTo(scrollListJDom);
			myScroll.refresh();
			if(myScroll.maxScrollY < 0 ){
				myScroll.scrollToElement('li:nth-last-child(1)', 200)
			}
			//发给后台
			$.get("http://4.huanyou.sinaapp.com/private_message/postMessage",{access_token:Global.common.access_token,to_user_id:_talkingUid,content:msg},function(result){
				try{
					result = JSON.parse(result);
				}catch(err){};
				if(typeof result != 'object' && result.code != '1'){
					alert('消息:"'+msg+'" 发送失败,请重试');
				}
			})
		}else{
			alert('不能发现空消息哦');
		}
	});

	$("#dialog").live('pageinit',function(){
		scrollListJDom = $('#dialog-wrapper .list').first();
		//编译模板
		$.template('DialogYourMsgTmpl',scrollListJDom);
		$.template('DialogMyMsgTmpl',$("#dialog-myMsgTmpl"));
		scrollListJDom.empty();
		$("#dialog-myMsgTmpl").remove();
	});

	$("#dialog").live('pagebeforeshow',function(){
		if(Global.common.access_token == null){
				alert("请先登陆");
				Global.Login.show();
		}else{
			if(_talkingNickName != null && _talkingNickName != ''){
				$('#dialog .banner').first().html(_talkingNickName);
			}else{
				$('#dialog .banner').first().html('聊天');
			}
			scrollListJDom.empty();
			_needLoadNewMsg = true;
			if(myScroll == null){
				myScroll = new iScroll('dialog-wrapper');
			}
			loadNewMsg();
		}
	});

	$("#dialog").live('pagehide',function(){
		_needLoadNewMsg = false;
		myScroll.destroy();
		myScroll = null;
	});

})();

/*============================================
 * 消息模块
 * ===========================================*/
Global.Message = new(function(){
	var scrollListJDom;
	var myScroll = null;
	var _startId = 0;
	var _needGetNewMsgCount = false;
	var myMedia = null;
	var resultCount = 0;


	function playAudioAndVibrate(){
		try{
			if(Global.Setting.voice == true){
				if(myMedia == null){
					myMedia = new Media("/android_asset/www/audio/message.mp3");
				}
				myMedia.play();
			}
			if(Global.Setting.vibration == true){
				navigator.notification.vibrate(500);
			}
		}catch(err){}
	}

	function getNewMessageCount(){
		//加载信息
		$.get("http://4.huanyou.sinaapp.com/private_message/messageNotify",{access_token:Global.common.access_token,start_id:_startId,only_count:1,r:Math.random()},function(result){
			try{
				result = JSON.parse(result);
			}catch(err){};
			if(result != null){
				switch(result.code){
					case 1:
						$("#main .msgCount").html(result.count);
						$("#main .msgCount").show();
						if(result.count > resultCount){
							playAudioAndVibrate();
						}
						resultCount = result.count;
					break;
					case -1:
						resultCount = 0;
						$("#main .msgCount").hide();
					default:
					break;
				}
			}
			if(_needGetNewMsgCount){
				setTimeout(function(){getNewMessageCount()},30000);
			}
		})
		
	}

	$(function(){
		setTimeout(function(){
			if(Global.common.access_token != null){
				_needGetNewMsgCount = true;
				getNewMessageCount();
			}
		}, 5000);
	})

	this.startGetNewMsgCount = function(){
		 _needGetNewMsgCount = true;
		 getNewMessageCount();
	}

	this.stopGetNewMsgCount = function(){
		 _needGetNewMsgCount = false;
	}


	function refreshData(){
		//加载信息
		$.get("http://4.huanyou.sinaapp.com/private_message/messageNotify",{access_token:Global.common.access_token,start_id:_startId,r:Math.random()},function(result){
			try{
				result = JSON.parse(result);
			}catch(err){};
			if(result != null){
				switch(result.code){
					case 1:
					$.tmpl("MessageItemTmpl",result.data).prependTo(scrollListJDom);
					start_id = result.data[0].id;
					break;
					case -1:
					alert('没有新的消息');
				}
			}else{
				alert('服务器错误,请重试');
			}
			if(myScroll == null){
				loadScroll();
			}
			myScroll.refresh();
		})
	}
	function loadScroll(){
		myScroll = MyScrollBuilder('message-wrapper',{
			pullDownId : 'message-pullDown',
			onPullDownScrollEnd : refreshData
		});
	}

	$("#message .list li").live('tap',function(event){
		uid = $(this).attr('data-uid');
		nickName = $(this).find('.name').html();
		imgSrc = $(this).children('.avatar').attr('src');
		Global.Dialog.show(uid,nickName,imgSrc);
	});
	$("#message").live('pageinit',function(){
		scrollListJDom = $("#message-wrapper .list").first();
		//编译模板
		$.template('MessageItemTmpl',scrollListJDom);
		scrollListJDom.empty();
	});

	$("#message").live('pageshow',function(){
		if(Global.common.access_token == null){
			alert("请先登陆");
			Global.Login.show();
			return;
		}

		scrollListJDom.empty();
		refreshData();
	});

	Global.handleBack.addBack('message',function(){ 
		location.hash = 'main';
	}); 
})();

/*=========================================
 * bookInfo模块
 * =======================================*/
;Global.bookInfo = new (function(){
	var _isbn = '';
	var _smid = 0;
	var _forward = '25';
	var _subjectId = 0;
	var _collectionId = 0;
	var _no_btn = 0;
	var _uid = 0;
	var _nickName = '';
	var _imgSrc = '';
	var init = 0;

	var iscroll,scrollListJDom_ul;
	var scrollListJDom = [];
	var now = $('.bookInfo .info_section:eq(0)');
	var tapping = false;
	var loading = -4;
	var pecent;
	var opacity = $('.bookInfo .opacity');
	var comment;
	var removing = false;
	var toRead = 1;

	//滑动
	$('.bookInfo .c_tab').live('tap',function(){
		if($(this).parent('.c_tabDiv').css('display') == 'none') return;
		pecent = $(this).attr('num')*_forward + '%';
		var sec = $(this).attr('sec');
		var section = '.bookInfo .info_section:eq(' + sec + ')';
		if(!tapping && $(section).css('display') == 'none'){
			tapping = true;
			$(this).siblings('.slideBg').animate({left:pecent},100);
			now.fadeOut('fast',function(){
				if(comment){
					$('.bookInfo .shut').tap();
				}
				$(section).fadeIn('fast',function(){
					if(iscroll)
						iscroll.refresh();
					tapping = false;
					now = $(section);
				});
			});
		}
	});

	$('.bookInfo .add_fav').live('tap',function(){
		$.getJSON('http://4.huanyou.sinaapp.com/swap_message/collect',{access_token:Global.common.access_token,subjectID:_subjectId},function(data){
			if(data){
				alert('添加成功！');
				Global.favourite.api = true;
				location.hash = 'favourite';
			}else{
				alert('添加失败！');
			}
		});
	});

	$('.bookInfo .del_fav').live('tap',function(){
		$.getJSON('http://4.huanyou.sinaapp.com/swap_message/noCollect',{access_token:Global.common.access_token,collectionID:_collectionId},function(data){
			if(data){
				alert('移除成功！');
				Global.favourite.api = true;
				location.hash = 'favourite';
			}else{
				alert('移除失败！');
			}
		});
	});

	$('.bookInfo .a_sea').live('tap',function(){
		toRead = 0;
		Global.Around.searchByIsbn(_isbn);
	});

	$('.bookInfo .send_ms').live('tap',function(){
		toRead = 0;
		Global.Dialog.show(_uid,_nickName,_imgSrc);
	});

	$('.bookInfo .commentLi').live('tap',function(){
		if(!removing){
			removing = true;
			opacity.show();
			comment = $(this).children('.bookInfo .main_comment').clone();
			opacity.after(comment);
			var string = $('.bookInfo .sections div').css('-webkit-transform');
			if(string.indexOf('-') != '-1')
				var top = (parseInt(string.slice(string.indexOf('-') + 1,string.indexOf(')'))) + 12) + 'px';
			comment.css('top',top);
			comment.show();
		}
	});

	$('.bookInfo .opacity').live('tap',function(){
		$(this).siblings('.main_comment').children('.shut').tap();
		return false;
	});

	$('.bookInfo .shut').live('tap',function(){
		opacity.hide();
		console.log(comment);
		if(comment){
			comment.remove();
			removing = false;
		}
		return false;
	});

	$('#bookInfo').live('pageinit',function(){
		//设置模版
		scrollListJDom_ul = $('.bookInfo .info_section .commentPart .commentUl').first();
		$.template('CommentTmpl',scrollListJDom_ul);
		scrollListJDom_ul.empty();
		for(var i = 0;i<3;i++){
			var temp = '.bookInfo .info_section:eq(' + i + ')';
			var t_temp = 'bookInfoTmpl_' + i;
			scrollListJDom.push($(temp).first());
			$.template(t_temp,scrollListJDom[i]);
			scrollListJDom[i].empty();
		}
	});

	$('#bookInfo').live('pageshow',function(){
		if(toRead){
			refreshData();
		}else{
			toRead = 1;
			$('#bookInfo-waiting').fadeOut();
			loading = -4;
		}
	});

	$('#bookInfo').live('pagehide',function(){
		now = $('.bookInfo .info_section:eq(0)');
		$('.bookInfo .opacity').siblings('.main_comment').children('.shut').tap();
		$('#bookInfo-waiting').fadeIn('fast');
		$('.bookInfo .info_section').hide();
		$('.bookInfo .info_section:eq(0)').fadeIn();
		$('.bookInfo .slideBg').css('left','0');
	});

	function refreshData(){
		$.getJSON('http://4.huanyou.sinaapp.com/swap_message/basicView',{isbn:_isbn},function(data){
			if(data){
				_subjectId = data.subjectID;
				if(!_no_btn){
					if(_forward == '33.3'){
						data.del = 1;
					}else data.add = 1;
				}
				scrollListJDom[0].empty();
				$.tmpl('bookInfoTmpl_0',data).appendTo(scrollListJDom[0]);
				loading++;
				if(!iscroll)
					iscroll = MyScrollBuilder('c_sections');
				if(!loading){
					iscroll.refresh();
					$('#bookInfo-waiting').fadeOut();
					loading = -4;
				}
			}else{
				alert('error');
			}
		});
		$.getJSON('http://4.huanyou.sinaapp.com/swap_message/specificView',{isbn:_isbn},function(data){
			if(data){
				scrollListJDom[1].empty();
				$.tmpl('bookInfoTmpl_1',data).appendTo(scrollListJDom[1]);
				loading++;
				if(!iscroll)
					iscroll = MyScrollBuilder('c_sections');
				if(!loading){
					iscroll.refresh();
					$('#bookInfo-waiting').fadeOut();
					loading = -4;
				}
			}else{
				alert('error');
			}
		});
		if(_smid){
			$.getJSON('http://4.huanyou.sinaapp.com/swap_message/swap_messageView',{sm_id:_smid},function(data){
				if(data){
					_uid = data.data.user_id;
					_nickName = data.data.nickname;
					_imgSrc = data.data.imgsrc;
					scrollListJDom[2].empty();
					$.tmpl('bookInfoTmpl_2',data.data).appendTo(scrollListJDom[2]);
					loading++;
					if(!iscroll)
						iscroll = MyScrollBuilder('c_sections');
					if(!loading){
						iscroll.refresh();
						$('#bookInfo-waiting').fadeOut();
						loading = -4;
					}
				}else{
					alert('error');
				}
			});
		}else{
			loading++;
		}
		$.getJSON('http://4.huanyou.sinaapp.com/swap_message/review',{isbn:_isbn},function(data){
			if(data){
				scrollListJDom_ul.empty();
				$.tmpl('CommentTmpl',data.review).appendTo(scrollListJDom_ul);
				$('.bookInfo .score').html(' ' + data.average);
				$('.bookInfo .numComment').html(data.num_rater);
				$('.bookInfo .starPart').fadeIn('fast');
				var star = 'bigStar' + Math.floor(data.average);
				$('.bookInfo .info_section .starPart .bigStar').attr('class','bigStar' + ' ' + star);
				loading++;
				if(!iscroll)
					iscroll = MyScrollBuilder('c_sections');
				if(!loading){
					iscroll.refresh();
					$('#bookInfo-waiting').fadeOut();
					loading = -4;
				}
			}else{
				alert('error');
			}
		});
	}

	/* 公共接口
	 * 传参传入
	 * {isbn: 必须
	 *  smid: 传了就不用传forward
	 *  forward: 没有分享人信息请传33.3}
	 **/
	this.toViewInfo = function(){
		_isbn = arguments[0].isbn || _isbn;
		_smid = arguments[0].smid || _smid;
		_collectionId = arguments[0].collectionId || _collectionId;
		_forward = arguments[0].forward || '25';
		_no_btn = arguments[0].no_btn || _no_btn;
		$('.bookInfo .c_tabDiv').css('display','none');
		if(_forward == '33.3'){
			$('.bookInfo .c_tabDiv:eq(1)').css('display','-webkit-box');
		}else{
			$('.bookInfo .c_tabDiv:eq(0)').css('display','-webkit-box');
		}
		location.hash = 'bookInfo';
	}
})();

/*==========================================
 * shared模块
 * ========================================*/
;Global.shared = new (function(){
	var shared_g_iscroll;
	var s_tf = $('.shared .tab_finished');
	var s_tg = $('.shared .tab_going');
	var going = $('.shared .shared_g_list');
	var finished = $('.shared .shared_f_list');
	var slideBg = $('.shared .slideBg');
	var tapping = false;
	var scrollListJDom_g,scrollListJDom_f;
	var pullDownEl;
	//tab 滑动
	s_tf.live('tap',function(){
		if(!tapping && finished.css('display') == 'none'){
			tapping = true;
			slideBg.animate({left:'50%'},100);
			going.fadeOut('fast',function(){
				finished.fadeIn('fast',function(){
					if(shared_g_iscroll)
						shared_g_iscroll.refresh();
					tapping = false;
				});
			});
		}
	});
	s_tg.live('tap',function(){
		if(!tapping && going.css('display') == 'none'){
			tapping = true;
			slideBg.animate({left:'0%'},100);
			finished.fadeOut('fast',function(){
				going.fadeIn('fast',function(){
					if(shared_g_iscroll)
						shared_g_iscroll.refresh();
					tapping = false;
				});
			})
		}
	});
	
	function shared(){
		//修改
		$('.shared .modify').live('tap',function(){
			var m_p = $(this).parent();
			var isbn = m_p.parents('li').attr('isbn');
			Global.modify.setIsbn(isbn);
			location.hash = "modify";
		});

		//延时
		$('.shared .delay').live('tap',function(){
			var thisdelay = this;
			var id = $(this).attr("value");
			try{
			$.getJSON("http://4.huanyou.sinaapp.com/swap_message/prolong",{sm_id:id},function(data){
				if(data['code'] == 1) {
					var target = $(thisdelay).parents(".buttonSet").siblings(".lastTime").children("span");
					target.css({"color":"red","font-weight":"900"}).html(data['end_time']);
					setTimeout(function(){
						target.css({"color":"black","font-weight":"100"});
					},1000);
				}
				else if(data['code'] == -1){
					alert("不能继续延时");
				}
				else{
					alert("延时失败！");
				}
			});
			}catch(error){
				alert("error!");
			}
		});
		
		//结束下架
		$('.shared .end').live('tap',function(){
			var thisend = this;
			var id = $(this).attr("value");
			try{
			$.getJSON("http://4.huanyou.sinaapp.com/swap_message/offBoard",{sm_id:id,access_token:Global.common.access_token},function(data){
				if(data['code'] == 1) {
					$(thisend).parents(".sharedList_li").slideUp("slow",function(){
						refreshData(1);
					});
				}	
				else{
					alert("操作失败！");
				}
			});
			}catch(error){
				alert("error!");
			}
		});
	}
	
	// 重新分享
	function reShare(){
		$('.shared .reshare').live('tap',function(){
			var thisReshare = this;
			var id = $(this).attr("value");
			try{
			$.getJSON("http://4.huanyou.sinaapp.com/swap_message/reShare",{sm_id:id,access_token:Global.common.access_token},function(data){
				if(data['code'] == 1) {
					$(thisReshare).parents(".sharedList_li").slideUp("slow",function(){
						refreshData(1);
					});
				}	
				else{
					alert("操作失败！");
				}
			});
			}catch(error){
				alert("error!");
			}
		});
	}
	
	function loadScroll(){
		function onPullDownScrollEnd(){refreshData(0,finished.css('display') == 'none',going.css('display') == 'none');}
		shared_g_iscroll = MyScrollBuilder('shared-scroll',{pullDownId:'shared-waiting',onPullDownScrollEnd:onPullDownScrollEnd});
	}

	function refreshData(){
		if(arguments[0] || arguments[1]){
			$.getJSON("http://4.huanyou.sinaapp.com/swap_message/goingPublished",{access_token:Global.common.access_token},function(data){
				if(data && data.code == '1'){
					scrollListJDom_g.empty();
					$.tmpl("SharedTmpl_g",data.going).appendTo(scrollListJDom_g);
					if(shared_g_iscroll && finished.css('display') == 'none' && going.css('display') != 'none'){
						shared_g_iscroll.refresh();
					}else{
						loadScroll();
					}
				}else{
					scrollListJDom_g.empty();
					data.no = 1;
					$.tmpl("SharedTmpl_g",data).appendTo(scrollListJDom_g);
					if(shared_g_iscroll && finished.css('display') == 'none' && going.css('display') != 'none'){
						shared_g_iscroll.refresh();
					}else{
						loadScroll();
					}
				}
			});
		}
		if(arguments[0] || arguments[2]){
			$.getJSON("http://4.huanyou.sinaapp.com/swap_message/finishPublished",{access_token:Global.common.access_token},function(data){
				if(data && data.code == '1'){
					scrollListJDom_f.empty();
					$.tmpl("SharedTmpl_f",data.finish).appendTo(scrollListJDom_f);
					if(going.css('display') == 'none' && finished.css('display') != 'none'){
						shared_g_iscroll.refresh();
					}
				}else{
					scrollListJDom_f.empty();
					data.no_too = 1;
					$.tmpl("SharedTmpl_f",data).appendTo(scrollListJDom_f);
					if(going.css('display') == 'none' && finished.css('display') != 'none'){
						shared_g_iscroll.refresh();
					}
				}
			});
		}
	}

	function init(){
		scrollListJDom_g = $("#shared-scroll div .shared_g_list").first();
		scrollListJDom_f = $("#shared-scroll div .shared_f_list").first();
		//编译模板
		$.template("SharedTmpl_g",scrollListJDom_g);
		$.template("SharedTmpl_f",scrollListJDom_f);
		scrollListJDom_g.empty();
		scrollListJDom_f.empty();
		shared();
		reShare();
	}

	$('#shared').live('pageinit',function(){
		init();
	});

	$('#shared').live('pageshow',function(){
		if(Global.common.access_token == null){
			alert("请先登陆");
			Global.Login.show();
			return;
		}
		if(!shared_g_iscroll)
			refreshData(1);
	});

	Global.handleBack.addBack('shared',function(){
			location.hash = 'main';
	});
})();

/*==================================
 * 抖一抖模块
 * ================================*/
Global.rock = new (function(){
   /*  $('#rock').tap(function(){ */
		// Global.Around.rock();
	/* }) */
	// watch id 是当前“watchAcceleration”的引用
	var watchID = null;
	
	// 等待加载PhoneGap
	document.addEventListener("deviceready", onDeviceReady, false);
	
	// PhoneGap加载完毕
	function onDeviceReady() {
		$('#rock').live('pageshow',startWatch);
	}

	$('#rock').live('pagehide',stopWatch);

	// 开始监视加速度
	function startWatch() {
		// 每隔.5秒钟更新一次加速度数据
		var options = { frequency: 500 };
		watchID = navigator.accelerometer.watchAcceleration(onSuccess, onError, options);
	}
	
	// 停止监视加速度
	function stopWatch() {
		if (watchID) {
			navigator.accelerometer.clearWatch(watchID);
			watchID = null;
		}
	}
	
	// onSuccess: 获取当前加速度数据的快照
	function onSuccess(acceleration) {
		if(acceleration.x > 12 || acceleration.y > 12 || acceleration.z > 14)
			Global.Around.rock();
	}
	
	// onError: 获取加速度失败
	function onError() {
		alert('onError!');
	}

	Global.handleBack.addBack('rock',function(){
			location.hash = 'main';
	});
})();

/*
*********
shuyan
*********
*/
/*===============================
百度地图
===============================*/
Global.mymap = new (function(){
	this.longitude;
	this.latitude;
	this.address;
	var back = -1; //0为返回发布页面，1为返回修改页面，2为周边页面
	var thismap = this;
	
	this.getPos = function(){
		return [this.longitude,this.latitude];
	}
	this.setPos = function(pos){
		this.longitude = pos[0];
		this.latitude = pos[1];
	}

	this.getBack = function(){
		return back;
	}
	this.setBack = function(flag){
		back = flag;
	}
	//$("#map_container").live("pageshow",function(){
	this.init = function(){
		var pos =[];
		
		switch(back){
			case 0: pos = Global.shareBook.getPos();break;
			case 1: pos = Global.modify.getPos(); break;
			case 2: pos = Global.Around.getPos();
		}
	
		if(!pos[0] || !pos[1]){
			//pos = thismap.pos();
			Global.common.longitude = "113.404773";
			Global.common.latitude = "23.059658";
			pos[0] = "113.404773";
			pos[1] = "23.059658";
		}
		thismap.longitude = pos[0];
		thismap.latitude = pos[1];
		
		MapLoader.ready(function(){
		var map = new BMap.Map("map_container"); //创建地图实例
		var point = new BMap.Point(thismap.longitude,thismap.latitude); //创建点坐标
		map.centerAndZoom(point,15); //初始化地图，设置中心点坐标和地图级别
		map.addControl(new BMap.NavigationControl()); //添加缩放控件
		
		$("#map_container").css({"position":"absolute"}).addClass("map_pos");

		/*++++++++++++
		定义自定义选定位置的覆盖物的构造函数
		++++++++++++*/
		function CircleOverlay(center,radiu,color){
			this._center = center;
			this._radiu = radiu;
			this._color = color;
		}
		//继承API的BMao.Overlay
		CircleOverlay.prototype = new BMap.Overlay();
		//实现初始化方法
		CircleOverlay.prototype.initialize = function(map){
			// 保存map对象实例
			this._map = map;
			//创建div元素，作为自定义覆盖物的容器
			var div = document.createElement('div');
			div.style.position = "absolute";
			//根据参数设置元素外观
			div.style.width = this._radiu + "px";
			div.style.height = this._radiu + "px"; 
			var b_radiu = this._radiu / 2.0 + "px";
			$(div).css("border-radius",b_radiu);
			div.style.background = this._color;
			//将div添加到覆盖物容器中
			 map.getPanes().markerPane.appendChild(div);
			//保存div实例
			this._div = div;
			// 需要将div元素作为方法的返回值，当调用该覆盖物的show、  
			 // hide方法，或者对覆盖物进行移除时，API都将操作此元素。  
			 return div;
		}
		//实现绘制方法
		CircleOverlay.prototype.draw = function(){
			// 根据地理坐标转换为像素坐标，并设置给容器  
			 var position = this._map.pointToOverlayPixel(this._center);  
			 this._div.style.left = position.x - this._radiu / 2.0 + "px";  
			 this._div.style.top = position.y - this._radiu / 2.0 + "px";
		}
		//实现显示方法
		CircleOverlay.prototype.show = function(){
			if(this._div){
				this._div.style.display = "";
			}
		}
		//实现隐藏方法
		CircleOverlay.prototype.hide = function(){
			if(this._div){
				this._div.style.display = "none";
			}
		}
		//移动覆盖物
		CircleOverlay.prototype.move = function(pos){
			 var position = this._map.pointToOverlayPixel(pos);  
			 this._div.style.left = position.x - this._radiu / 2.0 + "px";  
			 this._div.style.top = position.y - this._radiu / 2.0 + "px";
		}
		/*++++++++++++
		定义自定义操作板覆盖物
		++++++++++++*/
		function DivOverlay(center,text,color){
			this._center = center;
			this._text = text;
			this._color = color;
		}
		//继承API的BMao.Overlay
		DivOverlay.prototype = new BMap.Overlay();
		//实现初始化方法
		DivOverlay.prototype.initialize = function(map){
			// 保存map对象实例
			this._map = map;
			//创建div元素，作为自定义覆盖物的容器
			var div = document.createElement('div');
			div.style.position = "absolute";
			//根据参数设置元素外观
			div.style.width = "200px";
			div.style.height = "30px";
			div.style.padding = "5px"; 
			div.style.background = this._color;
			$(div).css({"border-radius":"5px","border":"1px solid #aaa"});
			//设置div内的内容
			var inner = "<div class='S_map_text' style='display:inline-block;width:120px;font-size:.85em;text-align:center;padding:4px 0 text-overflow:ellipsis;white-space:mowrap;text-shadow:none;'>" + this._text + 
						"</div><button width='30px' class='S_map_button btn' style='float:right;margin:0 5px;padding: 4px 10px'>确定</button>";
			$(div).append(inner);
			//将div添加到覆盖物容器中
			 map.getPanes().markerPane.appendChild(div);
			//保存div实例
			this._div = div;
			// 需要将div元素作为方法的返回值，当调用该覆盖物的show、  
			 // hide方法，或者对覆盖物进行移除时，API都将操作此元素。  
			 return div;
		}
		//实现绘制方法
		DivOverlay.prototype.draw = function(){ 
			 //this._div.style.left = "0px";  
			 //this._div.style.top = "0px";  
			 // 根据地理坐标转换为像素坐标，并设置给容器  
			 var position = this._map.pointToOverlayPixel(this._center);  
			 this._div.style.left = position.x - 100 + "px";  
			 this._div.style.top = position.y - 60 + "px";
		}
		//改变text
		DivOverlay.prototype.text = function(text){
			$(this._div).find(".S_map_text").html(text);
		}
		//移动div覆盖物
		DivOverlay.prototype.move = function(pos){
			 var position = this._map.pointToOverlayPixel(pos);  
			 this._div.style.left = position.x - 100 + "px";  
			 this._div.style.top = position.y - 60 + "px";
		}
		
		var myGeo = new BMap.Geocoder();
		var point = new BMap.Point(thismap.longitude,thismap.latitude);
		var myCircle = new CircleOverlay(point,10,"red");
			map.addOverlay(myCircle);
		var myDiv = new DivOverlay(point,"","#4d963b");
			map.addOverlay(myDiv);
		var initpos = "";
		try{
			myGeo.getLocation(point,function(result){
				if(result){
					initpos = result.address;
				}
				else{
					initpos = "加载失败";
				}
				thismap.address = initpos;
				myDiv.text(initpos);
			});
		}catch(error){
			alert(error);
		}

		map.addEventListener("click",function(e){		
			myCircle.move(e.point);
			myDiv.move(e.point);
			myGeo.getLocation(e.point,function(result){
				if(result){
					myDiv.text(result.address);
					thismap.address = result.address;
					thismap.longitude = result.point.lng;
					thismap.latitude = result.point.lat;
				}
			});
		});
		
		$(myDiv._div).find(".S_map_button").bind("tap",function(){
			$("#map_container").css("position","relative").removeClass("map_pos");
			switch(back){
				case 0:
					Global.shareBook.setPos([thismap.longitude,thismap.latitude]);
					Global.shareBook.setLocation(thismap.address);
					$("#shareBook").children("#map_container").remove();
					Global.shareBook.refresh();
					break;
				case 1:
					Global.modify.setPos([thismap.longitude,thismap.latitude]);
					Global.modify.setLocation(thismap.address);
					$("#modify").children("#map_container").remove();
					Global.modify.refresh();
					break;
				case 2:
					Global.Around.setPos([thismap.longitude,thismap.latitude],thismap.address);
					$("#around").children("#map_container").remove();
					Global.Around.refresh();
			}
			
			$(map).unbind();
		});
		
		});
	}
	//});
	
	//确定现在位置的经纬度
	this.pos = function(){
		if(arguments.length){
			return[arguments[0],arguments[1]];
		} 
		else {
			if(!Global.common.longitude || !Global.common.latitude){		
				var onSuccess = function(position) {
					Global.common.longitude = position.coords.latitude;
					Global.common.latitude = position.coords.longitude;
				}
				var onError = function(error) {
					alert('定位错误，为你定位到广州大学城');
					Global.common.longitude = "113.404773";
					Global.common.latitude = "23.059658";
				}
				navigator.geolocation.getCurrentPosition(onSuccess, onError);
			}
			var longitude = Number(Global.common.longitude);
			var latitude = Number(Global.common.latitude);
			return [longitude,latitude];
		}
	}
	
})();

/*================================
分享书籍
================================*/
Global.shareBook = new (function(){
	var publish = {};
	this.pos = [];
	this.address = "";
	this.getPos = function(){
		return this.pos;
	}
	this.setPos = function(point){
		this.pos[0] = point[0];
		this.pos[1] = point[1];
	}
	this.getLocation = function(){
		return this.address;
	}
	this.setLocation = function(loc){
		this.address = loc;
	}
	var shareB = this;
		
	$('.shareBook .S_inf_detail').live('tap',function(){
		Global.bookInfo.toViewInfo({isbn:$(".shareBook_isbnBox").val(),forward:'33.3',no_btn:1});
	});

	this.init = function(){
		if(!this.pos.length){
			this.pos = Global.mymap.pos();
			var pos = this.pos;
		
			MapLoader.ready(function(){
				var myGeo = new BMap.Geocoder(); 
				myGeo.getLocation(new BMap.Point(pos[0],pos[1]), function(result){
					 if (result){
						 this.address = result.address;
						 $('#shareBook .S_td1').html(result.address); 
					 }  
				});
			});
		}
		else{
			$('#shareBook .S_td1').html(this.address);
		}
		if($("#map_container")){
			$("#map_container").remove();
		}
		$("#shareBook").children().css("display","");
		$("#shareBook .S_bookInfMod").css("display","none");
		$("#shareBook .shareBook_isbnBox").val("");
		$("#shareBook .S_detailText").val("");
	}
	this.refresh = function(){
		if(this.address){
			$('#shareBook .S_td1').html(this.address);
		}
		$("#shareBook").children().css("display","");
		$("#shareBook .S_isbnhelp").css("display","none");
	}
	$("#shareBook").live('pageshow',function(){
		if(Global.common.access_token == null){
			location.hash = "main";
			var conf = navigator.notification.confirm("请先登录",function(button){
				if(button == true){
					Global.Login.show();
				}
			},'提示');
			return;
		}else{
			shareB.init();
		}
	});
	
	//退出页面
	$("#shareBook").live("pagehide",function(){
		$("#shareBook").children("#map_container").remove();
		shareB.refresh();
	});

	/*isbn码提交按钮*/
	var shareBookSummit = $('.shareBook_summit');
	ButtonEvent(shareBookSummit,{
		vmouseup:function(){
			var isbn = $(".shareBook_isbnBox").val();
			var p = /(\d{9,12}[\dA-Za-z])(?![\dA-Za-z])/g;
			if(!isbn){
				alert("请输入isbn码");
			}
			else if(p.exec(isbn)){
				var showdiv = $("#shareBook .S_bookInfMod");
				var hiddendiv = $("#shareBook .S_isbnhelp");
				showdiv.css("display","block");
				hiddendiv.css("display","none");
				//加载书籍信息
				$.get("http://4.huanyou.sinaapp.com/swap_message/pre_look_by_Isbn",{isbn:isbn},function(data){
					if(data){
						publish = $.parseJSON(data);
						if(publish.title){
							$('.shareBook .no_book').css('display','none');
							$("#shareBook .S_imgDiv img").attr("src",publish['imgsrc']);
							$("#shareBook .S_inf_title").html(publish['title']);
							$("#shareBook .S_inf_author").html(publish['author']);
							$("#shareBook .S_inf_detail").attr("value",publish['isbn']);
							$("#shareBook .S_load").css("display","none");
							$("#shareBook .S_BookInf").css("display","-webkit-box");
						}else{
							$("#shareBook .S_BookInf").css("display","none");
							$('.shareBook .no_book').css('display','block');
							$("#shareBook .S_load").css("display","none");
						}
					}
					else{
						alert("error");
					}
				}); 
			}
			else{
				alert("isbn码不正确！");
			}
		}
	});

	/*更改按钮*/
	$("#shareBook .S_td2 a").live("tap",function(){
		Global.mymap.setBack(0);
		//location.hash = "map_container";
		$("#shareBook").children().css("display","none");
		$("#shareBook").append('<div id="map_container" class="page map_container"></div>');
		Global.mymap.init();
	});
	
	/*确定分享按钮*/
	var shareBtn = $('#shareBook .S_shareBtn');
	ButtonEvent(shareBtn,{
		tap:function(){
			/* var location = new Array();
			$(".S_td1").each(function(){
				location.push($(this).html());
			}); */
			//收集数据
			publish.access_token = Global.common.access_token;
			publish.longitude = shareB.pos[0];
			publish.latitude = shareB.pos[1];
			publish.location = shareB.address;
			publish.comment = $(".S_detailText").val();
			//提交数据
			try{
			$.get("http://4.huanyou.sinaapp.com/swap_message/publish",publish,function(data){
				var data = $.parseJSON(data);
				if(data.code == 1){
					var conf = navigator.notification.confirm("分享成功!" + '\n' + "继续分享？",function(button){
						if(button == true){
							shareB.init();
						}else{
							location.hash = "main";
						}
					},'请选择');
				}
				else if(data['description']){
					alert(data['description']);
				}else{
					alert("error!");
				}
			});
			}catch(error){
				alert("error!");
			}
			
		}
	});

	//取消按钮
	var cancelBtn = $('.shareBook .S_cancel');
	ButtonEvent(cancelBtn,{
		tap:function(){
			location.hash = 'main';
		}
	});

	Global.handleBack.addBack('shareBook',function(){
		location.hash = 'main';
	});
})();

/*按钮类(为按钮绑定事件)*/
function ButtonEvent(btnid,obj){
	var btn = btnid;
	var obj = obj;
	if(!obj.vmousedown){
		btn.bind("vmousedown",function(){
			btn.attr('id','btn_down');
		});
		 btn.bind("vmouseup",function(){
			btn.attr('id','');
		}); 
	}
	for(event in obj){
		btn.bind(event,obj[event]);
	}
}

/*==============================
修改
==============================*/
Global.modify = new (function(){
	var _isbn = "";
	var address = "";
	var pos = [];
	this.getIsbn = function(){
		return _isbn;
	}
	this.setIsbn = function(isbn){
		_isbn = isbn;
	}
	this.getPos = function(){
		return pos;
	}
	this.setPos = function(point){
		pos[0] = point[0];
		pos[1] = point[1];
	}
	this.setLocation = function(loc){
		address = loc;
	}
	this.refresh = function(){
		$("#modify").children().css("display","");
		$("#modify .S_td1").html(address);
	}
	
	var mdf = this;
	
	$('.modify .S_inf_detail').live('tap',function(){
		Global.bookInfo.toViewInfo({isbn:_isbn,forward:'33.3',no_btn:1});
	});
	
	$("#modify").live('pagebeforeshow',function(){
		//清空本页面的数据
		   //清空书的信息
		$("#modify .S_imgDiv img").attr("src","");
		$("#modify .S_inf_title").html("");
		$("#modify .S_inf_author").html("");
		$("#modify .S_inf_detail").attr("value","");
		
		$("#modify .S_load").css("display","block");
		$("#modify .S_BookInf").css("display","none");
		   //清空用户信息
		$("#modify .S_td1").html("");
		$("#modify .S_detailText").val("");
	});
	
	$("#modify").live('pageshow',function(){
		//加载书号为isbn的书的信息
		var modify = null;
		$.get("http://4.huanyou.sinaapp.com/swap_message/modify",{isbn:_isbn,access_token:Global.common.access_token},function(data){
			if(data){
				modify = $.parseJSON(data);
				//加载书的信息
				$("#modify .S_imgDiv img").attr("src",modify['imgsrc']);
				$("#modify .S_inf_title").html(modify['title']);
				$("#modify .S_inf_author").html(modify['author']);
				$("#modify .S_inf_detail").attr("value",modify['isbn']);
				
				$("#modify .S_load").css("display","none");
				$("#modify .S_BookInf").css("display","-webkit-box");
				//加载用户信息
				pos[0] = modify['longitude'];
				pos[1] = modify['latitude'];
				address = modify['location'];
				
				$("#modify .S_td1").html(address);
				var comment = modify['comment'];
				$("#modify .S_detailText").val(comment);
			}
			else{
				alert("error");
			}
		});
	});
	
	//退出页面
	$("#modify").live("pagehide",function(){
		$("#modify").children("#map_container").remove();
		mdf.refresh();
	});
	
	/*更改按钮*/
	var changeAddress = $("#modify .S_td2 a");
		ButtonEvent(changeAddress,{
			tap: function(){
				Global.mymap.setBack(1);
				//location.hash = "map_container";
				$("#modify").children().css("display","none");
				$("#modify").append('<div id="map_container" class="page map_container"></div>');
				Global.mymap.init();
			}
		});

	//确认修改按钮
	var modifyBtn = $("#modify .S_shareBtn");
	modifyBtn.unbind();
	ButtonEvent(modifyBtn,{
		tap:function(){
			if(modify){
				var mdfData = {};
				mdfData.isbn = _isbn;
				mdfData.access_token = Global.common.access_token;
				mdfData.longitude = pos[0];
				mdfData.latitude = pos[1];
				mdfData.location = address;
				mdfData.comment = $("#modify .S_detailText").val();
				$.get("http://4.huanyou.sinaapp.com/swap_message/modify",mdfData,function(data){
					if(data == 1){
						alert("修改成功");
						location.hash = "shared";
					}else{
						alert("error!");
					}
				});
			}
		}
	});
	//取消按钮
	var cancelBtn = $("#modify .S_cancel");
	ButtonEvent(cancelBtn,{
		tap: function(){
			location.hash = "shared";
		}
	});
})();
/*===============================
我的收藏
================================*/
Global.favourite = new (function(){
	var me = this;
	this.api = false;
	var favourite_iscroll;
	var value = '0';
	var data = null;
	var favourit_scrollList;
	
	$('#favourite').live('pageshow',function(){
		if(Global.common.access_token == null){
			alert("请先登陆");
			Global.Login.show();
			return;
		}
		if(!favourite_iscroll)
			refreshData();
		if(me.api)
			refreshData();
	});

	$("#favourite").live('pageinit',function(){
		favourit_scrollList = $("#favourite_ul").first();
		$.template("favouriteMessageTmpl",favourit_scrollList);
		favourit_scrollList.empty();
	});

	$("#favourite .c_tab").bind("tap",function(){
		var val = $(this).attr("value");
		if(val != value){
			value = val;
			if(data){
				changeData(value);
			}
		}
	});

	$('#favourite .lookAround').live('tap',function(){
		Global.Around.searchAround();
		return false;
	});
	
	function refreshData(){
		$.get("http://4.huanyou.sinaapp.com/swap_message/mycollect",{access_token:Global.common.access_token},function(dataRev){
			if(dataRev){
				data = $.parseJSON(dataRev);
				changeData(value);
			}else{
				alert("error!");
			}
		});
	}
	
	function changeData(val){
		var left = val * 33.4 + "%";
		var readdata = {};
		$("#favourite .slideBg").animate({left:left},100);
		$("#favourite-wrapper").fadeOut('fast',function(){
			switch(val){
				case '0':
					readdata = data['wish'];
					if(readdata.code == 0){
						readdata['result'] = {no_title:1,type:'想读的'};
					}
					break;
				case '1': 
					readdata = data['reading'];
					if(readdata.code == 0){
						readdata['result'] = {no_title:1,type:'在读的'};
					}
					break;
				case '2': 
					readdata = data['read'];
					if(readdata.code == 0){
						readdata['result'] = {no_title:1,type:'读过的'};
					}
					break;
				default:alert("error!");
			}
			readValue(readdata);
			$(this).fadeIn('fast',function(){
				if(!favourite_iscroll)
					loading();
				else
					favourite_iscroll.refresh();
			});
		});
	}
	
	function readValue(readdata){
		//将页面内容清空
		favourit_scrollList.empty();
		//插入数据
		$.tmpl("favouriteMessageTmpl",readdata['result']).appendTo(favourit_scrollList);
	}

	//查看本书信息
	$(".favourite_list").live("tap",function(){
		if($(this).children('.no_review').length > 0) return;
		var list = this;
		var isbn = $(this).attr('isbn');
		var _collectionId = $(this).attr('c_id');
		Global.bookInfo.toViewInfo({isbn:isbn,forward:'33.3',collectionId:_collectionId})
	});
	
	//搜索本书
	$(".favourite_searchBtn").live("tap",function(){
		var search = this;
		var isbn = $(this).parent('li').attr('isbn');
		Global.Around.searchByIsbn(isbn);
		return false;
	});

	function loading(){
		favourite_iscroll = MyScrollBuilder('favourite-wrapper',{
			pullDownId : 'favourite-waiting',
			onPullDownScrollEnd:refreshData
		});
	}

	Global.handleBack.addBack('favourite',function(){
			location.hash = 'main';
	});
})();

/*===========================
设置
===========================*/
Global.Setting = new (function(){
	this.voice = true; //要本地获取
	this.vibration = true;
	this.background = "0";
	var set = this;
	// var back = true; //判断是否回到主页
	
	$("#setting").live('pagebeforeshow',function(){
		//判断登陆状态
		if(Global.common.access_token != null){
			$("#setting .login").text("已登录,点击注销");
		}else{
			$("#setting .login").text("登录");
		}
		// back = true;
		var voiceSwitch = $(".voiceSelect");
		var vibrationSwitch = $(".vibrationSelect");
		//声音
		if(set.voice){	
			voiceSwitch[0].selectedIndex = 1;
			voiceSwitch.slider("refresh");
		}else{
			voiceSwitch[0].selectedIndex = 0;
			voiceSwitch.slider("refresh");
		}
		//震动
		if(set.vibration){
			vibrationSwitch[0].selectedIndex = 1;
			vibrationSwitch.slider("refresh");
		}else{
			vibrationSwitch[0].selectedIndex = 0;
			vibrationSwitch.slider("refresh");
		}
	});

	//点击登陆
	$("#setting .login").live("tap",function(){
		// back = false;
		//注销
		if(Global.common.access_token != null ){
			Global.common.access_token = null;
			Global.Message.stopGetNewMsgCount();
			kremove('access_token');
			$("#setting .login").text("登录");
		//登陆
		}else{
			Global.Login.show();
		}
	})
	
	//退出页面时设置声音和震动
   /*  $("#setting").live("pagebeforehide",function(){ */
		// if($(".voice :checked").val() == "on"){
			// set.voice = true;
		// }else{
			// set.voice = false;
		// }
		// if($(".vibration :checked").val() == "on"){
			// set.vibration = true;
		// }else{
			// set.vibration = false;
		// }
	/* }); */
	
	//设置聊天背景
	$("#setting .background").live("tap",function(){
		// back = false;
		location.hash = "setBg";
	});
	
	//清空聊天记录
	$("#setting .clearRecord").live("tap",function(){
		alert("已清空聊天记录");
	});
	
	//关于我们
	$("#setting .aboutUs").live("tap",function(){
		// back = false;
		location.hash = "aboutUs";
	});

	$('.voiceSelect').bind( "change", function(){
		set.voice = !set.voice;
	});

	$('.vibrationSelect').bind( "change", function(){
		set.vibration = !set.vibration;
	});

	Global.handleBack.addBack('setting',function(){
		location.hash = 'main';
	});
});

/*==========================
 * 登陆页
 * =========================*/
Global.Login = new(function(){

	this.show =  function(){
		window.plugins.childBrowser.showWebPage('http://4.huanyou.sinaapp.com/oauth/request_token.php',{showLocationBar:false});
		// window.plugins.childBrowser.onClose = function () {
			// alert('childBrowser has closed');
		// };

		window.plugins.childBrowser.onLocationChange = function (url) {
			if(url.indexOf('access_token') > -1){
				access_token = url.substring(url.indexOf('access_token')+13);
				if(access_token != 'null'){
					Global.common.access_token = access_token;
					kset('access_token',access_token);
					$("#setting .login").text("已登录,点击注销");
				}
				window.plugins.childBrowser.close();
			}
		};
		// historyPos = history.length;
		// location.hash = 'login';
	}
	
	// function onmessage(e){
		// if(e.data.access_token !== undefined){
			// Global.common.access_token = e.data.access_token;
			// kset('access_token',e.data.access_token);
			// $("#login").empty();
			// iFrame = null;
			// Global.Message.startGetNewMsgCount();
			// history.go(historyPos - history.length);
		// }else{
			// alert("授权失败.请重试!");
			// $("#login").empty();
			// iFrame = null;
			// history.go(historyPos - history.length);
		// }

	// }
	// window.addEventListener('message',onmessage,false);

	// $("#login").live('pageshow',function(){
		// $("#login").empty();
		// iFrame = null;
		// iFrame = document.createElement('iframe');
		// iFrame.src = 'http://4.huanyou.sinaapp.com/oauth/request_token.php';
		// $("#login").append(iFrame);
	// });
	
})();

/*=========================
设置聊天背景页
=========================*/
Global.SetBg = new (function(){
	this.background = Global.Setting.background;
	var pre = this.background;
	var setbg = this;
	var add = '<img class="selectImg" src="images/selected.png" alt="已选" />';
	
	$("#setBg .imgdiv").live("tap",function(){
		setbg.background = $(this).attr("value");
		var prediv = ".imgdiv:eq(" + pre + ")";
		var nowdiv = ".imgdiv:eq(" + setbg.background + ")";
		pre = setbg.background;
		$(prediv).children(".selectImg").remove();
		$(nowdiv).append(add);
	});
	
	$("#setBg").live("pageshow",function(){
		var nowdiv = ".imgdiv:eq(" + setbg.background + ")";
		$(nowdiv).append(add);
	});
	
	$("#setBg .selectBg").live("tap",function(){
		Global.Setting.background = setbg.background;
		var bg;
		if(setbg.background == "0"){
			bg = "#fff";
		}else{
			bg = "url('images/bgImgs/bg" + setbg.background + ".jpg')";
		}
		$("#dialog").css("background",bg);
		location.hash = "setting";
	});
})();

/*==========================
 * 按钮效果
 * ========================*/
(function(){
	$('.btn').live('vmousedown',function(){
		$(this).attr('id','btn_down');
	});
	$(document).live('vmouseup',function(){
		if($('#btn_down').length)
			$('#btn_down').attr('id','');
	});
})();


